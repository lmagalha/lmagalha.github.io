<html>
<head>

</head>

<body>

<script type="module">

      import {WebXRButton} from './js/util/webxr-button.js';
      import {Scene} from './js/render/scenes/scene.js';
      import {Renderer, createWebGLContext} from './js/render/core/renderer.js';
      import {SkyboxNode} from './js/render/nodes/skybox.js';
      import {Gltf2Node} from './js/render/nodes/gltf2.js';
	  
let xrRefSpace=null;
let gl=null;
let renderer=null;

      let scene = new Scene();
      let solarSystem = new Gltf2Node({url: 'media/gltf/space/space.gltf'});
      // The solar system is big (citation needed). Scale it down so that users
      // can move around the planets more easily.
      solarSystem.scale = [0.1, 0.1, 0.1];
      scene.addNode(solarSystem);

function initAR()
{

        if (navigator.xr) {
          navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
            console.log("AR content is supported!");
			onRequestSession();
          })
		  .catch((reason) => { console.log("AR content is not supported: " + reason); });
        }
}

      function onRequestSession() {
        // Requests an 'immersive-ar' session, which ensures that the users
        // environment will be visible either via video passthrough or a
        // transparent display. This may be presented either in a headset or
        // fullscreen on a mobile device.
        navigator.xr.requestSession('immersive-ar')
            .then((session) => {
              session.isImmersive = true;
			  console.log("Session requested!");
              onSessionStarted(session);
            });
      }
	  
      function initGL() {
        if (gl)
          return;

        gl = createWebGLContext({
          xrCompatible: true
        });
        document.body.appendChild(gl.canvas);

        function onResize() {
          gl.canvas.width = gl.canvas.clientWidth * window.devicePixelRatio;
          gl.canvas.height = gl.canvas.clientHeight * window.devicePixelRatio;
        }
        window.addEventListener('resize', onResize);
        onResize();

        renderer = new Renderer(gl);

        scene.setRenderer(renderer);
      }
	  
function onSessionStarted(xrSession) {


    initGL();

  xrSession.updateRenderState({
    baseLayer: new XRWebGLLayer(xrSession, gl)
  });

  xrSession.requestReferenceSpace('local')
  .then((refSpace) => {
    xrRefSpace = refSpace;
    xrSession.requestAnimationFrame(onXRFrame);
  });
}

      function onXRFrame(t, frame) {
        let session = frame.session;

        let pose = frame.getViewerPose(xrRefSpace);

        scene.startFrame();

        session.requestAnimationFrame(onXRFrame);

        scene.drawXRFrame(frame, pose);

        scene.endFrame();

      }  

initAR();
</script>
</body>

</html>
